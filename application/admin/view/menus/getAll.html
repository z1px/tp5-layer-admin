{layout name="layout:form" /}

<!-- head begin -->
<link rel="stylesheet" href="__ADMIN__/zTree/css/metroStyle/metroStyle.css" />
<!-- head end -->

<!-- foot begin -->
<script type="text/javascript" src="__ADMIN__/zTree/js/jquery.ztree.core.min.js"></script>
<script type="text/javascript" src="__ADMIN__/zTree/js/jquery.ztree.excheck.min.js"></script>
<script type="text/javascript" src="__ADMIN__/zTree/js/jquery.ztree.exedit.min.js"></script>
<!-- foot end -->

<fieldset class="layui-elem-field">
    <legend>菜单树</legend>
    <div class="layui-field-box">
        <ul id="menuTree" class="ztree" data-url="{:Url('admin/Menus/getAll')}"></ul>
    </div>
</fieldset>

<script>
    layui.use(['layer'], function() {
        var layer = layui.layer;
        var layerTips = parent.layerTips === undefined ? (parent.layer === undefined ? layui.layer : parent.layer) : layui.layerTips; //获取父窗口的layer对象

        var zTree;
        // zTree 配置项
        var setting= {
            view: {
                dblClickExpand: true,
                showLine: true,
                showIcon: false,
                selectedMulti: false,
                addHoverDom: addHoverDom,
                removeHoverDom: removeHoverDom
            },
            check: {
                enable: false
            },
            edit: {
                enable: true,
                drag: {
                    isMove: true,
                    prev: true,
                    next: true,
                    inner: true
                },
                showRemoveBtn: false,
                showRenameBtn: false
            },
            data: {
                simpleData: {
                    enable: true,
                    idKey: "id",
                    pIdKey: "pid"
                },
                key: {
                    name: "title"
                }
            },
            callback: {
                beforeDrag: beforeDrag,
                beforeRemove: beforeRemove,
                beforeRename: beforeRename,
                onRemove: onRemove,
                onRename: onRename,
                onDrop: onDrop
            }
        };

        $.post($("#menuTree").data("url"),{},function (data) {
            zTree = $.fn.zTree.init($("#menuTree"), setting, data);
        });

        function beforeRemove(treeId, treeNode) {
//            layerTips.confirm("确认删除 菜单 【<font color='red'>" + treeNode.title + "</font>】 吗？",function (index) {
//                layerTips.close(index);
//                return zTree.removedNodes;
//            },function (index) {
//                layerTips.close(index);
//                return false;
//            });
            return confirm("确认删除 菜单 【<font color='red'>" + treeNode.title + "</font>】 吗？");
        }
        function onRemove(event, treeId, treeNode) {
//            $.post("{:Url('admin/Menus/del')}",{id:treeNode.id},function (result) {
//                layerTips.msg(result.msg);
//                return result.code;
//            });
        }

        function beforeDrag(treeId, treeNodes) {
            return true;
        }
        function onDrop(event, treeId, treeNodes, targetNode, moveType) {
            $.post("{:Url('admin/Menus/editMenuPid')}",{id:treeNodes[0].id,pid:treeNodes[0].pid},function (result) {
                layerTips.msg(result.msg);
                return result.code;
            });
        }

        function beforeRename(treeId, treeNode, newName, isCancel) {
            if (newName.length == 0) {
                zTree.cancelEditName();
                layerTips.tips('菜单名称不能为空', "#"+treeNode.tId+"_a", {
                    tips: [2, '#009688'],
                    time: 1500
                });
                return false;
            }else{
                return true;
            }
        }
        function onRename(event, treeId, treeNode, isCancel) {
            $.post("{:Url('admin/Menus/editMenuTitle')}",{id:treeNode.id,title:treeNode.title},function (result) {
                layerTips.msg(result.msg);
                return result.code;
            });
        }


        function addHoverDom(treeId, treeNode) {
            var sObj = $("#" + treeNode.tId + "_span");
            if (treeNode.editNameFlag || $("#diyBtn_"+treeNode.tId+"_add").length>0 || $("#diyBtn_"+treeNode.tId+"_edit").length>0 || $("#diyBtn_"+treeNode.tId+"_remove").length>0) return;
            var addStr = '<span class="button add" id="diyBtn_'+ treeNode.tId+'_add" title="add node" onfocus="this.blur();"></span>';
            addStr += '<span class="button edit" id="diyBtn_'+ treeNode.tId+'_edit" title="rename" onfocus="this.blur();"></span>';
            addStr += '<span class="button remove" id="diyBtn_'+ treeNode.tId+'_remove" title="remove" onfocus="this.blur();"></span>';
            sObj.after(addStr);
            var btn_add = $("#diyBtn_"+treeNode.tId+"_add");
            var btn_edit = $("#diyBtn_"+treeNode.tId+"_edit");
            var btn_remove = $("#diyBtn_"+treeNode.tId+"_remove");
            if (btn_add) btn_add.bind("click", function(){
                edit('{:Url("admin/Menus/add")}'+"?pid="+treeNode.id,"新增菜单");
                return false;
            });
            if (btn_edit) btn_edit.bind("click", function(){
                edit('{:Url("admin/Menus/edit")}'+"?id="+treeNode.id,"修改菜单");
                return false;
            });
            if (btn_remove) btn_remove.bind("click", function(){
                layerTips.confirm("确认删除 菜单 【<font color='red'>" + treeNode.title + "</font>】 吗？",function (index) {
                    layerTips.close(index);
                    $.post("{:Url('admin/Menus/del')}",{id:treeNode.id},function (result) {
                        layerTips.msg(result.msg);
                        if(result.code==1) zTree.removeNode(treeNode);
                    });
                    return true;
                },function (index) {
                    layerTips.close(index);
                    return false;
                });
                return false;
            });
        }
        function removeHoverDom(treeId, treeNode) {
            $("#diyBtn_"+treeNode.tId+"_add").unbind().remove();
            $("#diyBtn_"+treeNode.tId+"_edit").unbind().remove();
            $("#diyBtn_"+treeNode.tId+"_remove").unbind().remove();
        }


        function edit(url,title) {
            var top_index=layerTips.open({
                type: 2,//0（信息框，默认）1（页面层）2（iframe层）3（加载层）4（tips层）
                title: title,
                maxmin : true, //最大最小化
                area : ['470px','600px'],//宽高
                content: url,
                cancel:function (index, layero) {
                    layerTips.confirm('若数据未保存，关闭后数据会丢失，确定要关闭吗？',function(ind){
                        layerTips.close(ind);
                        layerTips.close(index);
                        window.location.reload();
                    });
                    return false;
                }
            });
//            layerTips.full(top_index);//弹出即最大化
        }

    });
</script>